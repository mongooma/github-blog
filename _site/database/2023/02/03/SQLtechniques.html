<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      All-in-one MySQL techniques (beginner-intermediate) &middot; Elapsed
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  <!-- JS -->
  <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>
  <script src="https://code.jquery.com/jquery-3.3.0.min.js" integrity="sha256-RTQy8VOmNlT6b2PIRur37p6JEBZUE7o8wPgMvu18MC4=" crossorigin="anonymous"></script>
  <script src="/public/js/main.js"></script>

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
                                 <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">


</head>


  <body>

    


<div class="sidebar">
  <div class="sidebar-post-lead">
      <nav class="sidebar-nav-post-lead">
        <ul>
        </ul>
      </nav> 
  </div> 

  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          Elapsed
        </a>
      </h1>
      <p class="lead">Mostly frameworks.</p>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item" href="/">Recent</a>

      

      
      
        
      
        
          
            <a class="sidebar-nav-item" href="/about/">About Me</a>
          
        
      
        
          
            <a class="sidebar-nav-item" href="/categories/">Categories</a>
          
        
      
        
          
            <a class="sidebar-nav-item" href="/graphs/">On Graphs</a>
          
        
      
        
          
        
      

      <!-- <a class="sidebar-nav-item" href="/archive/v1.0.zip">Download</a> -->
      <!-- <a class="sidebar-nav-item" href="">GitHub project</a> -->
      <span class="sidebar-nav-item">Currently v1.0</span>
    </nav>

    <p>&copy; 2023. All rights reserved.</p>
  </div>
</div>


    <div class="content container">
      <!-- <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>
<script src="/public/js/main.js"></script> -->

<div class="post">
  <h1 class="post-title">All-in-one MySQL techniques (beginner-intermediate)</h1>
  <span class="post-date">03 Feb 2023</span>  
  <section>
    <p>Below is the copy of the gist project of my study notes for MySQL. The actual total study time is approximately ~20hrs, including my past experience with SQL and a weekend’s practice on Hackerrank. This guide is a quick reference of the common syntax, or a more simpler way to understand MySQL for those who are already familiar with other programming languages.</p>

<p>During practicing SQL, I find that the most important thing is to realize that, MySQL is basically a language that manipulates tables. The tables are the data structure for MySQL as the lists, tuples and dictionaries for Python.</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Edit log, 3.28.2023</code>: <em>I have used amateur terms and case examples to explain about SQL. Now after visiting a course on database system (I was a computational maths undergrad) I have known better organizations for these concepts. But I still like to keep the trace of the understanding simply from practicing coding examples so I won’t perform a complete reconstruction of this study note. However, I will keep updating this post by adding references to technical resources.</em></li>
</ul>

<hr />

<p>(<em>For practicing on Hackerrank</em>) Hackerrank features:</p>

<p>Mysql vs Mysql server on Hackerrank</p>
<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">with</code> clause sometimes cause error in mysql environment</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">--</code> comment cannot be written in the same line with the code</p>
  </li>
  <li>
    <p>In mysql, each <code class="language-plaintext highlighter-rouge">select</code> sentence is one line in the debugging message. In mysql server, the line number is in accordance with shown in the editor view.</p>
  </li>
</ul>

<p>Language behaviors:</p>

<ul>
  <li>
    <p>sql does not differ lower and upper cases;</p>
  </li>
  <li>
    <p>The <code class="language-plaintext highlighter-rouge">()</code> are mandatory for sub-conditions (even when only one condition is present!)</p>
  </li>
  <li>
    <p>The <code class="language-plaintext highlighter-rouge">=</code> is used in the same way for <code class="language-plaintext highlighter-rouge">==</code> as “is equivalent to”</p>
  </li>
  <li>
    <p>The <code class="language-plaintext highlighter-rouge">!=</code> is used the same way.</p>
  </li>
  <li>
    <p>The behavior of <code class="language-plaintext highlighter-rouge">/</code> is ambiguous. To ensure the integer result, use <code class="language-plaintext highlighter-rouge">ceil(), floor()</code></p>
  </li>
  <li>
    <p>Use <code class="language-plaintext highlighter-rouge">is NULL</code> and <code class="language-plaintext highlighter-rouge">is not NULL</code> to check null values. <code class="language-plaintext highlighter-rouge">= null</code> will not be right.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">sqrt()</code>, <code class="language-plaintext highlighter-rouge">power()</code> used in the same fashions.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">length()</code> to get the length (number of bytes) of the string.</p>
  </li>
  <li>
    <p>Use <code class="language-plaintext highlighter-rouge">from table1, table2, ...</code> directly for the descarte product.</p>
  </li>
  <li>
    <p>Use <code class="language-plaintext highlighter-rouge">limit n</code> to select the first n rows of data. Rank desc on some column first to select the “last” rows. Run <code class="language-plaintext highlighter-rouge">() union ()</code> to select both. <code class="language-plaintext highlighter-rouge">union</code> requires brackets.</p>
  </li>
  <li>
    <p>Use <code class="language-plaintext highlighter-rouge">count(*)</code> to get the number of rows in the table.</p>
  </li>
  <li>
    <p>Use <code class="language-plaintext highlighter-rouge">max()</code> to return null of the row does not exist.</p>
  </li>
  <li>
    <p>The window functions: <code class="language-plaintext highlighter-rouge">row_number()</code> gives distinct numbers, <code class="language-plaintext highlighter-rouge">rank()</code> gives non-distinct and non-continuous numbers, <code class="language-plaintext highlighter-rouge">dense_rank()</code> gives distinct and continuous numbers.</p>
  </li>
</ul>

<hr />
<h2 id="string-manipulation">String manipulation</h2>

<p>To manipulate the string output, write something like:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="n">concat</span><span class="p">(</span><span class="nv">"Hi, "</span><span class="p">,</span> <span class="k">COUNT</span><span class="p">(</span><span class="n">NAME</span><span class="p">),</span> <span class="s1">' of '</span><span class="p">,</span> <span class="n">substr</span><span class="p">(</span><span class="n">occupation</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="s1">'s.'</span><span class="p">)</span> 
<span class="k">from</span> <span class="n">occupations</span> 
<span class="k">group</span> <span class="k">by</span> <span class="n">occupation</span> 
<span class="k">order</span> <span class="k">by</span> <span class="k">COUNT</span><span class="p">(</span><span class="n">NAME</span><span class="p">),</span> <span class="n">occupation</span><span class="p">;</span>
</code></pre></div></div>

<p>Notice in the above example, the simple <code class="language-plaintext highlighter-rouge">concat</code> is used to format a string, <code class="language-plaintext highlighter-rouge">substr(s, pos, num)</code> acts as <code class="language-plaintext highlighter-rouge">string[pos+1:pos+1+num]</code>`` to get part of the string. See <a href="https://learnsql.com/blog/5-functions-manipulating-sql-strings/">here</a> for more ways to manipulate the string output.</p>

<h2 id="select">Select</h2>

<p>The basic select sentence is of structure:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="k">COLUMN</span> <span class="k">from</span> <span class="k">TABLE</span> <span class="k">where</span> <span class="n">CONDITION</span> 
</code></pre></div></div>

<p>To intepret the sentence, it’s actually of this order</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="k">COLUMN</span> <span class="k">from</span> <span class="p">(</span><span class="k">TABLE</span> <span class="k">where</span> <span class="n">CONDITION</span><span class="p">)</span>
</code></pre></div></div>

<p>The table will be loaded into the scope (all the column names). 
Therefore the column names are free to refer after select or in the CONTIDION.</p>

<p>To use group by and aggregated functions:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="k">MAX</span><span class="p">(</span><span class="k">COLUMN</span><span class="p">)</span> <span class="k">from</span> <span class="p">((</span><span class="k">TABLE</span> <span class="k">where</span> <span class="n">CONDITION</span><span class="p">)</span> <span class="k">group</span> <span class="k">by</span> <span class="k">COLUMN</span><span class="p">)</span> 
</code></pre></div></div>

<p>Here the ordering is <code class="language-plaintext highlighter-rouge">table where ...</code> to get the slicing by some column value conditioning, and then <code class="language-plaintext highlighter-rouge">group by ...</code> to get the bags/sets of the rows, and finally the aggregation func to perform on the desired column.</p>

<p>So notice the <code class="language-plaintext highlighter-rouge">select</code> syntax is better interpretated as “get”, rather than a active selection as if it’s a functional verb that should be run as the first move.</p>

<p>And when using multiple tables, the <code class="language-plaintext highlighter-rouge">join</code> is written like:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="k">COLUMN</span> <span class="k">from</span> <span class="p">((</span><span class="n">TABLE1</span> <span class="k">left</span> <span class="k">join</span> <span class="n">TABLE2</span> <span class="k">on</span> <span class="n">TABLE1</span><span class="p">.</span><span class="k">column</span> <span class="o">=</span> <span class="n">TABLE2</span><span class="p">.</span><span class="k">column</span><span class="p">)</span> <span class="k">where</span> <span class="n">CONDITION</span><span class="p">)</span> <span class="p">...</span>
</code></pre></div></div>

<p>Since obviously the first step is to get the complete joined table into the scope, then slicing and etc.</p>

<p>To order the syntax for the <code class="language-plaintext highlighter-rouge">select</code> sentence it should be:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="k">MAX</span><span class="p">(</span><span class="k">column</span><span class="p">)</span> <span class="k">as</span> <span class="n">col1</span><span class="p">,</span> <span class="n">column2</span> <span class="k">as</span> <span class="n">col2</span>
<span class="k">from</span> 
      <span class="p">(((</span><span class="n">TABLE1</span>
        <span class="k">left</span> <span class="k">join</span> <span class="n">TABLE2</span> <span class="k">on</span> <span class="n">TABLE1</span><span class="p">.</span><span class="n">COL1</span> <span class="o">=</span> <span class="n">TABLE2</span><span class="p">.</span><span class="n">COL2</span><span class="p">)</span>
          <span class="k">where</span> <span class="n">condition</span><span class="p">)</span>
            <span class="k">group</span> <span class="k">by</span> <span class="n">column2</span><span class="p">)</span>   <span class="cm">/* could not use the alias */</span>
<span class="k">order</span> <span class="k">by</span> <span class="n">col2</span> <span class="k">DESC</span><span class="p">;</span> <span class="cm">/* could use the alias */</span>
</code></pre></div></div>

<p>So the efficiency priority goes:</p>

<ol>
  <li>
    <p>Join multiple tables</p>
  </li>
  <li>
    <p>Slicing using column c conditioning</p>
  </li>
  <li>
    <p>Bagging the rows by some column a</p>
  </li>
  <li>
    <p>Ordering the rows by some column b (seems to be on the same level with <code class="language-plaintext highlighter-rouge">select</code>)</p>
  </li>
</ol>

<p>Notice that 1 &amp; 2 will change the content of the table in the scope, and 2 as slicing should go after 1 joining.
As for 3 and 4, even they might use different columns thus have no sequential dependency, but if first bagging, the next row ordering could have fewer rows to deal with, thus more efficient.</p>

<p>For a more detailed explanation see <a href="https://sqlbolt.com/lesson/select_queries_order_of_execution">here</a>.</p>

<h3 id="select-from-multiple-tables">Select from multiple tables</h3>

<p>In <a href="https://www.hackerrank.com/challenges/the-company/problem?isFullScreen=false">this example</a>, the problem asks to gather the information from 5 tables under one <code class="language-plaintext highlighter-rouge">company_code</code> id. This should be a typical setting. And one solution from the discussion looks like:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> 
 <span class="k">MAX</span><span class="p">(</span><span class="k">c</span><span class="p">.</span><span class="n">company_code</span><span class="p">),</span> 
 <span class="k">MAX</span><span class="p">(</span><span class="k">c</span><span class="p">.</span><span class="n">founder</span><span class="p">),</span>
 <span class="p">(</span><span class="k">SELECT</span> <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">lm</span><span class="p">.</span><span class="n">lead_manager_code</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">Lead_Manager</span> <span class="n">lm</span> <span class="k">WHERE</span> <span class="k">c</span><span class="p">.</span><span class="n">company_code</span> <span class="o">=</span> <span class="n">lm</span><span class="p">.</span><span class="n">company_code</span><span class="p">),</span>
 <span class="p">(</span><span class="k">SELECT</span> <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">sm</span><span class="p">.</span><span class="n">senior_manager_code</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">Senior_Manager</span> <span class="n">sm</span> <span class="k">WHERE</span> <span class="k">c</span><span class="p">.</span><span class="n">company_code</span> <span class="o">=</span> <span class="n">sm</span><span class="p">.</span><span class="n">company_code</span><span class="p">),</span>
 <span class="p">(</span><span class="k">SELECT</span> <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">m</span><span class="p">.</span><span class="n">manager_code</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">Manager</span> <span class="n">m</span> <span class="k">WHERE</span> <span class="k">c</span><span class="p">.</span><span class="n">company_code</span> <span class="o">=</span> <span class="n">m</span><span class="p">.</span><span class="n">company_code</span><span class="p">),</span>
 <span class="p">(</span><span class="k">SELECT</span> <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">e</span><span class="p">.</span><span class="n">employee_code</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">Employee</span> <span class="n">e</span> <span class="k">WHERE</span> <span class="k">c</span><span class="p">.</span><span class="n">company_code</span> <span class="o">=</span> <span class="n">e</span><span class="p">.</span><span class="n">company_code</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">Company</span> <span class="k">c</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="k">c</span><span class="p">.</span><span class="n">company_code</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="k">c</span><span class="p">.</span><span class="n">company_code</span> <span class="k">ASC</span>
</code></pre></div></div>

<p>Notice the structure has a use of <a href="https://www.geeksforgeeks.org/implicit-join-vs-explicit-join-in-sql/">“implicit join”</a>
which has the structure as</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="n">col1</span><span class="p">,</span> <span class="n">col2</span><span class="p">,</span> <span class="n">col3</span> <span class="cm">/* the column names in table 1 and table 2 */</span>
<span class="k">from</span> <span class="n">table1</span><span class="p">,</span> <span class="n">table2</span>
<span class="k">where</span> <span class="n">table1</span><span class="p">.</span><span class="n">foreign_key</span> <span class="o">=</span> <span class="n">table2</span><span class="p">.</span><span class="n">foreign_key</span>
</code></pre></div></div>
<p>And it has combined multiple <code class="language-plaintext highlighter-rouge">(select)</code> into one “meta” select, and each sub-select will generate one column.</p>

<p>But the implicit join is not encouraged to use nowadays (someone says it will throw out errors regarding null values, and it’s hard to write many conditions in <code class="language-plaintext highlighter-rouge">where</code> (?)). The explicit join could be written as</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="k">C</span><span class="p">.</span><span class="n">company_code</span><span class="p">,</span>
        <span class="k">C</span><span class="p">.</span><span class="n">founder</span><span class="p">,</span>
        <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">L</span><span class="p">.</span><span class="n">lead_manager_code</span><span class="p">),</span>
        <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">S</span><span class="p">.</span><span class="n">senior_manager_code</span><span class="p">),</span>
        <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">M</span><span class="p">.</span><span class="n">manager_code</span><span class="p">),</span> 
        <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">E</span><span class="p">.</span><span class="n">employee_code</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">Company</span> <span class="k">C</span> 
<span class="k">LEFT</span> <span class="k">JOIN</span> <span class="n">Lead_Manager</span> <span class="n">L</span> <span class="k">on</span> <span class="k">C</span><span class="p">.</span><span class="n">company_code</span> <span class="o">=</span> <span class="n">L</span><span class="p">.</span><span class="n">company_code</span>
<span class="k">LEFT</span> <span class="k">JOIN</span> <span class="n">Senior_Manager</span> <span class="n">S</span> <span class="k">on</span> <span class="n">L</span><span class="p">.</span><span class="n">lead_manager_code</span> <span class="o">=</span> <span class="n">S</span><span class="p">.</span><span class="n">lead_manager_code</span>
<span class="k">LEFT</span> <span class="k">JOIN</span> <span class="n">Manager</span> <span class="n">M</span> <span class="k">on</span> <span class="n">S</span><span class="p">.</span><span class="n">senior_manager_code</span> <span class="o">=</span> <span class="n">M</span><span class="p">.</span><span class="n">senior_manager_code</span>
<span class="k">LEFT</span> <span class="k">JOIN</span> <span class="n">Employee</span> <span class="n">E</span> <span class="k">on</span> <span class="n">M</span><span class="p">.</span><span class="n">manager_code</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">manager_code</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="k">C</span><span class="p">.</span><span class="n">company_code</span><span class="p">,</span> <span class="k">C</span><span class="p">.</span><span class="n">founder</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="k">C</span><span class="p">.</span><span class="n">company_code</span><span class="p">;</span>
</code></pre></div></div>
<p>(Notice the <code class="language-plaintext highlighter-rouge">on .col1 = .col2</code> has to be aligned with the joining order ‘&lt;-‘)</p>

<p>The structure of the giant joined table is</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>company_code founder | 
company_code founder lead_manager_code | 
company_code founder lead_manager_code senior_manager_code | ...
</code></pre></div></div>
<p>Notice the columns with the same names have been preserved within the giant table, and they could still be referred by <code class="language-plaintext highlighter-rouge">table.col</code>.</p>

<p>This shows that <code class="language-plaintext highlighter-rouge">join</code> only links (as allowing the data communication between) the tables but has not actively done anything.</p>

<h2 id="casewhen">Case…when…</h2>

<p>To output for different occasions, use <code class="language-plaintext highlighter-rouge">case {when...then}*n else end</code> as:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="n">N</span><span class="p">,</span> 
<span class="k">case</span>
    <span class="k">when</span> <span class="p">(</span><span class="n">P</span> <span class="k">is</span> <span class="k">null</span><span class="p">)</span> <span class="k">then</span> <span class="nv">"Root"</span>
    <span class="k">when</span> <span class="p">(</span><span class="n">N</span> <span class="k">in</span> <span class="p">(</span><span class="k">select</span> <span class="n">P</span> <span class="k">from</span> <span class="n">BST</span><span class="p">))</span> <span class="k">then</span> <span class="nv">"Inner"</span>
    <span class="k">else</span> <span class="nv">"Leaf"</span>
<span class="k">end</span>
<span class="k">from</span> <span class="n">BST</span><span class="p">;</span>
</code></pre></div></div>

<p>Notice the last case is <code class="language-plaintext highlighter-rouge">else</code>, and as all the script language asked for an <code class="language-plaintext highlighter-rouge">end</code> to signature the close of the segment.</p>

<p>In the above example <code class="language-plaintext highlighter-rouge">order by</code> follows the table loading. It should be interpreted as order the rows first, and then do the <code class="language-plaintext highlighter-rouge">select</code>.</p>

<h3 id="casewhen-pivoting-table">Case…when… pivoting table</h3>

<p>The following example is to use <code class="language-plaintext highlighter-rouge">case...when...</code> to pivot a table</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="n">a</span> <span class="k">as</span> <span class="p">(</span>
<span class="k">select</span> 
    <span class="k">case</span> <span class="k">when</span> <span class="n">occupation</span><span class="o">=</span><span class="s1">'doctor'</span> <span class="k">then</span> <span class="n">name</span> <span class="k">end</span> <span class="k">as</span> <span class="n">doctor</span> <span class="p">,</span> <span class="cm">/* notice the column is singularly generated this way */</span>
    <span class="k">case</span> <span class="k">when</span> <span class="n">occupation</span><span class="o">=</span><span class="s1">'professor'</span> <span class="k">then</span> <span class="n">name</span> <span class="k">end</span> <span class="k">as</span> <span class="n">professor</span> <span class="p">,</span>
    <span class="k">case</span> <span class="k">when</span> <span class="n">occupation</span><span class="o">=</span><span class="s1">'singer'</span> <span class="k">then</span> <span class="n">name</span> <span class="k">end</span> <span class="k">as</span> <span class="n">singer</span><span class="p">,</span> 
    <span class="k">case</span> <span class="k">when</span> <span class="n">occupation</span><span class="o">=</span><span class="s1">'actor'</span> <span class="k">then</span> <span class="n">name</span> <span class="k">end</span> <span class="k">as</span> <span class="n">actor</span><span class="p">,</span> 
    <span class="n">row_number</span><span class="p">()</span> <span class="n">over</span> <span class="p">(</span><span class="k">partition</span> <span class="k">by</span> <span class="n">occupation</span> <span class="k">order</span> <span class="k">by</span> <span class="n">name</span><span class="p">)</span> <span class="k">as</span> <span class="n">ran</span> 
<span class="k">from</span> <span class="n">occupations</span><span class="p">)</span>

<span class="k">select</span> <span class="k">min</span><span class="p">(</span><span class="n">doctor</span><span class="p">),</span> <span class="k">min</span><span class="p">(</span><span class="n">professor</span><span class="p">),</span> <span class="k">min</span><span class="p">(</span><span class="n">singer</span><span class="p">),</span> <span class="k">min</span><span class="p">(</span><span class="n">actor</span><span class="p">)</span> <span class="k">from</span> <span class="n">a</span> <span class="k">group</span> <span class="k">by</span> <span class="n">ran</span>

</code></pre></div></div>

<p>Notice the <code class="language-plaintext highlighter-rouge">a</code> as a temporary table is of the structure as following:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>a in the same effect as: (rows in the original order)
(occupation) doctor_names   ...    actor_names  ran
---------------------------------------------------
doctor        name          ...       null     1
doctor        name          ...       null     2
actor         null          ...       name     1
actor         null          ...       name     2
</code></pre></div></div>

<p>So when the <code class="language-plaintext highlighter-rouge">case...when</code> use a single case to generate one column based on the original column, the unfit row-column entries will yield <code class="language-plaintext highlighter-rouge">null</code>.</p>

<p>The pivoting is partly finished at this point. But the row order column here is the key to align the ordering within each partition in the way:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>p1  p2  p3
-----------
v11 v21 v31
v12 v22 v32
v13 v23 v33
... ... ...
</code></pre></div></div>
<p>The effect is that the null values will be placed at the bottom of the column-rowset.</p>

<p>The short-hand <code class="language-plaintext highlighter-rouge">pivot</code> simplifies the grammar, like this:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span>
<span class="p">[</span><span class="n">Doctor</span><span class="p">],</span> <span class="p">[</span><span class="n">Professor</span><span class="p">],</span> <span class="p">[</span><span class="n">Singer</span><span class="p">],</span> <span class="p">[</span><span class="n">Actor</span><span class="p">]</span>
<span class="k">from</span> <span class="p">(</span>
    <span class="k">select</span> <span class="n">row_number</span><span class="p">()</span> <span class="n">over</span><span class="p">(</span><span class="k">partition</span> <span class="k">by</span> <span class="n">occupation</span> <span class="k">order</span> <span class="k">by</span> <span class="n">name</span><span class="p">)</span> 
    <span class="cm">/* agg() over (partition by ... order by ...)*/</span>
    <span class="cm">/* use row_number()/rank()/dense_rank()/ to preserve the original partition data*/</span>
    <span class="cm">/* ntile(n) will give n rows for each partition */</span>
    <span class="k">as</span> <span class="n">rk</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">occupation</span>
    <span class="k">from</span> <span class="n">occupations</span>
<span class="p">)</span> <span class="k">as</span> <span class="n">t1</span>
<span class="n">pivot</span> <span class="p">(</span> <span class="cm">/* in the same effect as case ...when..., see above*/</span>
    <span class="k">min</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>  <span class="cm">/* applys on individual cell specified by the row number; but has to be an aggregation func; MIN, MAX both works*/</span>
    <span class="k">for</span> <span class="n">occupation</span> <span class="k">in</span> <span class="p">(</span><span class="n">Doctor</span><span class="p">,</span> <span class="n">Professor</span><span class="p">,</span> <span class="n">Singer</span><span class="p">,</span> <span class="n">Actor</span><span class="p">)</span>
    <span class="cm">/* here the for...in () takes "table-value" rather than "string-value", so no "" needed, write the "table-value" as-is here */</span>
<span class="p">)</span> <span class="k">as</span> <span class="n">t2</span><span class="p">;</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">t1</code> looks like:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rk       name              occupation
---------------------------------------
1        name              doctor     
1        name              actor     
2        name              doctor     
2        name              actor     
</code></pre></div></div>
<p>And then using <code class="language-plaintext highlighter-rouge">pivot</code> and specifying the pivoted columns. The <code class="language-plaintext highlighter-rouge">min(name)</code> will act on the individual rows, rather than the partitioned by occupation row-set, because of the constraint of the column tuple <code class="language-plaintext highlighter-rouge">(rk, name)</code>, therefore the aggregation cannot go beyond the level of row.</p>

<h3 id="more-about-where">More about where</h3>

<p><code class="language-plaintext highlighter-rouge">where</code> could be intepreted as slicing, therefore the agg() could be used on the subset. It’s a more determinate row selecting.</p>

<p>When need to have a set of choice within the <code class="language-plaintext highlighter-rouge">case when... end</code> in the condition, do not write the choices in the list <code class="language-plaintext highlighter-rouge">case when condition then (c1, c2, c3)</code>, instead expand the subset to <code class="language-plaintext highlighter-rouge">or</code>:</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">...</span>
<span class="k">where</span> <span class="p">(</span><span class="n">col</span> <span class="o">=</span> <span class="p">(</span><span class="k">case</span> <span class="k">when</span> <span class="n">condition</span> <span class="k">then</span> <span class="n">c1</span><span class="p">)</span> <span class="k">or</span> <span class="p">(</span><span class="k">case</span> <span class="k">when</span> <span class="n">condition</span> <span class="k">then</span> <span class="n">c2</span><span class="p">)</span> <span class="k">or</span> <span class="p">(</span><span class="k">case</span> <span class="k">when</span> <span class="n">condition</span> <span class="k">then</span> <span class="n">c3</span><span class="p">))</span>
<span class="p">...</span>
</code></pre></div></div>
<p><strong>(However there must be a better way to implement this!)</strong></p>

<h3 id="the-having-clause">The having clause</h3>

<p><code class="language-plaintext highlighter-rouge">having</code> could be used to simplify the procedure of selecting only the part of the sub-bags, e.g. “the item count larger than k”. The grammar is like</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">select</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
<span class="k">from</span> <span class="k">table</span>
<span class="k">group</span> <span class="k">by</span> <span class="n">item</span>
<span class="k">having</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">k</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Note</code>: Check the syntax <code class="language-plaintext highlighter-rouge">group by ... having ...</code>.</li>
</ul>

<h2 id="use-sub-tabletemporary-tabletable-alias">Use sub-table/temporary table/table alias</h2>

<h3 id="with-and-table-alias">With and table alias</h3>

<p>All “derived” tables should have alias:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">select</span> <span class="p">...)</span> <span class="n">t</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">from () t where condition(t)</code>, the alias <code class="language-plaintext highlighter-rouge">t</code> is not seen by the <code class="language-plaintext highlighter-rouge">where</code> query.</p>

<p>The temporary alias table could be lifted out to the beginning into the <code class="language-plaintext highlighter-rouge">with clause</code>.</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="n">t</span> <span class="k">as</span> <span class="p">()</span>
<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">t</span>
</code></pre></div></div>

<p>When using multiple <code class="language-plaintext highlighter-rouge">with</code>, do this:</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="n">t1</span> <span class="k">as</span> <span class="p">(</span>
<span class="p">),</span>
<span class="n">t2</span> <span class="k">as</span> <span class="p">(</span>
<span class="cm">/* could refer to t1 in here */</span>
<span class="p">)</span>
<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">t2</span> <span class="k">where</span> <span class="p">...</span> <span class="cm">/* t1 is visible to the where query while t2 is not*/</span>
</code></pre></div></div>

<p>To set a variable, place the query before the <code class="language-plaintext highlighter-rouge">with</code>:</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Set</span> <span class="o">@</span><span class="k">variable</span> <span class="o">=</span> <span class="p">();</span> <span class="cm">/**/</span>
<span class="k">with</span> <span class="n">t1</span> <span class="k">as</span> <span class="p">(</span>
<span class="p">),</span>
<span class="n">t2</span> <span class="k">as</span> <span class="p">(</span>
<span class="p">)</span>
<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">t2</span> <span class="k">where</span> <span class="p">...;</span>
</code></pre></div></div>
<p>Therefore notice the <code class="language-plaintext highlighter-rouge">with</code> is within the select sentence as a clause.</p>

<h3 id="info-table-and-reference-table">Info table and reference table</h3>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Note</code>: Also check for “Primary key and foreign key”.</li>
</ul>

<p>In <a href="https://www.hackerrank.com/challenges/full-score/problem?isFullScreen=true">this problem</a>, it has two part of the information: the coder’s info, and the challenges’ info. The result returns the info of the coders based on their performance on the challenges. This could be interpreted as a “referring” relationship.</p>

<p>In the original submission the classic way is to create join tables. But SQL has a structure called “correlated subquery” which deals exactly this. The structure looks like:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="n">col</span> 
<span class="k">from</span> <span class="k">table</span> <span class="n">t1</span>
<span class="k">where</span> <span class="n">col</span> <span class="k">operator</span> <span class="p">(</span>
                  <span class="k">select</span> <span class="k">max</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> 
                  <span class="k">from</span> <span class="k">table</span> <span class="n">t2</span> 
                  <span class="k">where</span> <span class="n">t1</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">t2</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
</code></pre></div></div>

<p>For example,</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">last_name</span><span class="p">,</span> <span class="n">salary</span><span class="p">,</span> <span class="n">department_id</span>
 <span class="k">FROM</span> <span class="n">employees</span> <span class="k">outer</span>
 <span class="k">WHERE</span> <span class="n">salary</span> <span class="o">&gt;</span>
                <span class="p">(</span><span class="k">SELECT</span> <span class="k">AVG</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span>
                 <span class="k">FROM</span> <span class="n">employees</span>
                 <span class="k">WHERE</span> <span class="n">department_id</span> <span class="o">=</span>
                        <span class="k">outer</span><span class="p">.</span><span class="n">department_id</span> 
                 <span class="k">group</span> <span class="k">by</span> <span class="n">department_id</span><span class="p">);</span>
</code></pre></div></div>
<p>Notice the <code class="language-plaintext highlighter-rouge">group by</code> is also on the correlation column to make sure the comparability.</p>

<p>The effect of the above snippet is to compare the employee’s salary to the avg. in his department.
It’s similar to comparing the coder’s performance to the difficulty of the challenges he solved. (See the different submission for the implementation.)</p>

<p>And also for <a href="https://www.hackerrank.com/challenges/harry-potter-and-wands/problem?isFullScreen=true">this problem</a>.</p>


  </section>

</div>

<div class="related">
  <h2>Most Recent Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/project%20management/2023/02/18/PythonCrossFolderImport.html">
            Python: Cross-folder import
            <small>18 Feb 2023</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/algorithms/2023/02/15/backtracking.html">
            Writing Tree traversal for Backtracking
            <small>15 Feb 2023</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/maths/2023/02/09/geometric_sequence.html">
            Geometric Sequence Sum
            <small>09 Feb 2023</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>


    </div>

  </body>
</html>
